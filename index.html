<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×‘×“×™×§×ª ×¤×¨×˜×™ ×¨×›×‘</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary-blue: #3B82F6; --light-blue: #EFF6FF; --dark-blue: #1E3A8A;
      --text-gray: #6B7280; --border-color: #D1D5DB; --success-green: #10B981;
      --warning-yellow: #F59E0B; --danger-red: #EF4444;
    }
    body { font-family: 'Heebo', sans-serif; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); margin: 0; padding: 20px; color: #333; }
    .container { max-width: 880px; margin: 40px auto; background-color: #ffffff; border-radius: 24px; padding: 40px 30px 30px; box-shadow: 0 20px 40px -5px rgba(27, 100, 240, 0.15); border: 1px solid rgba(255, 255, 255, 0.5); }
    .logo { max-width: 150px; margin: 0 auto 25px; display: block; color: var(--primary-blue); }
    h1 { text-align: center; margin-bottom: 8px; color: var(--dark-blue); font-size: 32px; font-weight: 700; }
    .description { text-align: center; color: var(--text-gray); margin-bottom: 35px; font-size: 18px; }
    .input-group { display: flex; flex-direction: column; gap: 14px; align-items: stretch; }
    @media(min-width: 500px) { .input-group { flex-direction: row; justify-content: center; } }
    input[type="text"] { padding: 16px 20px; border-radius: 12px; border: 1px solid var(--border-color); font-size: 18px; width: 100%; text-align: center; transition: all 0.2s ease-in-out; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    input[type="text"]:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }
    button { padding: 16px 28px; background-color: var(--primary-blue); color: white; font-size: 17px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; transition: all 0.2s ease-in-out; box-shadow: 0 4px 12px -2px rgba(59, 130, 246, 0.4); }
    button:hover { background-color: #2563EB; transform: translateY(-2px); box-shadow: 0 6px 16px -2px rgba(59, 130, 246, 0.5); }
    button:disabled { background-color: #93C5FD; cursor: not-allowed; transform: translateY(0); box-shadow: none; }
    .actions-container { display: flex; justify-content: center; gap: 15px; margin-top: 25px; }
    .action-btn { background-color: var(--light-blue); color: var(--primary-blue); padding: 10px 20px; box-shadow: none; }
    .action-btn:hover { background-color: #DBEAFE; transform: translateY(-1px); box-shadow: none; }
    .hidden { display: none; }
    .results { margin-top: 20px; text-align: right; }
    .status-message { text-align: center; padding: 20px; border-radius: 12px; background-color: #FFFBEB; color: #B45309; font-size: 18px; font-weight: bold; margin: 20px 0; border: 1px solid #FDE68A; }
    .status-message.error { background-color: #FEF2F2; color: #DC2626; border-color: #FECACA; }
    .status-message.success { background-color: #F0FDF4; color: #15803D; border-color: #A7F3D0; }
    .status-message small { display: block; font-size: 14px; font-weight: 400; margin-top: 8px; }
    .section-title { margin: 35px 0 15px; font-weight: bold; font-size: 22px; border-bottom: 3px solid var(--primary-blue); display: inline-block; padding-bottom: 6px; color: var(--dark-blue); }
    ul { list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 5px; }
    li { display: flex; justify-content: space-between; align-items: center; padding: 14px 10px; border-bottom: 1px solid #f0f2f5; font-size: 16px; border-radius: 8px; transition: background-color 0.2s ease; }
    li:hover { background-color: var(--light-blue); }
    li strong { margin-left: 15px; color: #333; display: flex; align-items: center; flex-shrink: 0; }
    li strong i { margin-left: 10px; color: var(--primary-blue); width: 22px; text-align: center; font-size: 18px; }
    li span { color: var(--text-gray); text-align: left; word-break: break-word; }
    .loader { border: 5px solid #E5E7EB; border-top: 5px solid var(--primary-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .license-plate { display: flex; flex-direction: row-reverse; max-width: 400px; margin: 20px auto; border-radius: 8px; border: 4px solid #111; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .plate-country { background-color: #0038a8; color: white; padding: 5px 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .plate-country .flag { font-size: 20px; } .plate-country .il { font-size: 22px; font-weight: bold; } .plate-country .israel { font-size: 12px; }
    .plate-number { flex-grow: 1; background: linear-gradient(to bottom, #fecb04, #fdb813); color: black; font-size: 40px; font-weight: 700; letter-spacing: 4px; display: flex; align-items: center; justify-content: center; text-shadow: 1px 1px 1px rgba(0,0,0,0.1); padding: 5px; }
    .data-source-disclaimer { text-align: center; font-size: 13px; color: var(--text-gray); margin-top: 30px; }
    footer { display: flex; justify-content: space-between; align-items: center; max-width: 880px; margin: 30px auto 0; padding: 20px 10px 0; border-top: 1px solid var(--border-color); font-size: 14px; color: var(--text-gray); }
    footer p { margin: 0; } footer a { color: var(--primary-blue); text-decoration: none; } footer a:hover { text-decoration: underline; }
    .history-table-container { width: 100%; overflow-x: auto; margin-top: 15px; }
    .history-table { width: 100%; border-collapse: collapse; }
    .history-table th, .history-table td { padding: 10px; border: 1px solid #ddd; text-align: center; white-space: nowrap; }
    .history-table th { background-color: var(--light-blue); color: var(--dark-blue); }
    .rating-bar-container { width: 100%; background-color: #e9ecef; border-radius: 4px; overflow: hidden; direction: ltr; }
    .rating-bar { height: 12px; background-color: var(--primary-blue); border-radius: 4px; transition: width 0.5s ease-out; }
    @media print { body { padding: 0; margin: 0; } #main-content, #action-buttons, .loader, footer, .data-source-disclaimer { display: none !important; } .container { box-shadow: none !important; border: none !important; margin: 0 !important; padding: 0 !important; max-width: 100% !important; width: 100% !important; } .results-wrapper { display: block !important; } li { background-color: transparent !important; } }
  </style>
</head>
<body>
  <div class="container">
    <div id="main-content">
      <svg class="logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><circle cx="11.5" cy="14.5" r="2.5"></circle><path d="M13.25 16.25 15 18"></path></svg>
      <h1>×‘×“×™×§×ª ×¤×¨×˜×™ ×¨×›×‘ ×œ×¤×™ ××¡×¤×¨ ×¨×™×©×•×™</h1>
      <p class="description">×”×§×œ×“ ××¡×¤×¨ ×¨×›×‘ (4-8 ×¡×¤×¨×•×ª) ×•×œ×—×¥ ×× ×˜×¨ ××• ×¢×œ ×—×™×¤×•×©</p>
      <div class="input-group">
        <input type="text" id="plate" placeholder="×œ×“×•×’××”: 12-345-67" />
        <button id="searchButton" onclick="searchVehicle()"><i class="fas fa-search"></i> ×—×™×¤×•×©</button>
      </div>
    </div>
    <div class="actions-container hidden" id="action-buttons">
      <button class="action-btn" id="printBtn"><i class="fas fa-print"></i> ×”×“×¤×¡×”</button>
      <button class="action-btn" id="downloadBtn"><i class="fas fa-download"></i> ×”×•×¨×“×”</button>
      <button class="action-btn" id="shareBtn"><i class="fas fa-share-alt"></i> ×©×™×ª×•×£</button>
    </div>
    <div class="results-wrapper">
      <div id="licensePlateDisplay" class="hidden"></div>
      <div class="results" id="resultsArea"></div>
    </div>

    <div style="border: 1px solid #b3d7ff; background-color: #eaf4ff; padding: 12px; border-radius: 6px; text-align: center; font-size: 13px; margin-top: 20px;">
  <p>
    ×”××™×“×¢ ××‘×•×¡×¡ ×¢×œ × ×ª×•× ×™× ××××’×¨×™ ×”××™×“×¢ ×”×××©×œ×ª×™×™× ×”×¤×ª×•×—×™× ×•××•×¦×’ ×›×©×™×¨×•×ª ×œ×¦×™×‘×•×¨. ×”××ª×¨ ××™× ×• ××—×¨××™ ×œ×“×™×•×§ ×”××™×“×¢ ××• ×œ×¢×“×›× ×™×•×ª×•.
  </p>
    <p>
      ×œ×¤×¨×˜×™× × ×•×¡×¤×™× ×¢×œ ×”××ª×¨ ×•××§×•×¨ ×”× ×ª×•× ×™×, ×œ×—×¦×• 
      <a href="https://rechavimzelaze.ovh/post/75249" target="_blank" rel="noopener noreferrer">×›××Ÿ</a>.
      ×œ×ª×’×•×‘×•×ª ×•××©×•×‘, ×›× ×¡×• 
      <a href="https://rechavimzelaze.ovh/post/72731" target="_blank" rel="noopener noreferrer">×›××Ÿ</a>.
    </p>
  </div>

  </div>
  <footer>
    <p id="footer-year"></p>
    <p>×¢×™×¦×•×‘ ×•×¤×™×ª×•×—: <a href="https://github.com/mmichaelush" target="_blank">@××™×›××œ×•×©</a> ×‘×¡×™×•×¢ AI</p>
  </footer>
   <script>
    // ===================================================================================
    // --- ×”×’×“×¨×•×ª ×›×œ×œ×™×•×ª ×•××œ×× ×˜×™× ××”-HTML ---
    // ===================================================================================

    // ×§×™×©×•×¨ ×œ××œ×× ×˜×™× ×”××¨×›×–×™×™× ×‘×“×£ ×œ×¦×•×¨×š ×’×™×©×” × ×•×—×” ×•××”×™×¨×”
    const plateInput = document.getElementById("plate");
    const searchButton = document.getElementById("searchButton");
    const resultsArea = document.getElementById("resultsArea");
    const actionButtons = document.getElementById("action-buttons");
    const licensePlateDisplay = document.getElementById("licensePlateDisplay");
    
    // ×”×’×“×¨×•×ª ×’×œ×•×‘×œ×™×•×ª
    const API_BASE_URL = 'https://data.gov.il/api/3/action/datastore_search'; // ×›×ª×•×‘×ª ×”×‘×¡×™×¡ ×©×œ ×”-API
    const CANONICAL_URL = 'https://mmichaelush.github.io/MyOto/'; // ×”×›×ª×•×‘×ª ×”×¨×©××™×ª ×©×œ ×”××ª×¨ ×œ×¦×•×¨×š ×©×™×ª×•×£ × ×›×•×Ÿ ××ª×•×š ×”×˜××¢×•×ª
    let currentPlate = ''; // ××©×ª× ×” ×©×™×—×–×™×§ ××ª ××¡×¤×¨ ×”×¨×™×©×•×™ ×”× ×•×›×—×™ ×‘×—×™×¤×•×©
    const DEBUG_MODE = true; // ×©× ×” ×œ-true ×›×“×™ ×œ×¨××•×ª ×œ×•×’×™× ××¤×•×¨×˜×™× ×‘×§×•× ×¡×•×œ ×”×“×¤×“×¤×Ÿ

    // ===================================================================================
    // --- ×ª×¦×•×¨×ª ×××’×¨×™ ×”××™×“×¢ (DATA_SOURCES) ---
    // ===================================================================================
    // ××•×‘×™×™×§×˜ ××¨×›×–×™ ×”××’×“×™×¨ ××ª ×›×œ ×××’×¨×™ ×”××™×“×¢ ×©×× ×• ×©×•××œ×™×.
    const DATA_SOURCES = {
        // #1 - Primary: Private & Commercial Cars
        private_cars_1: { id: '053cea08-09bc-40ec-8f7a-156f0677aff3', doc_id: '#1', name: '×¨×›×‘ ×¤×¨×˜×™ ×•××¡×—×¨×™ 1', type: 'primary', searchField: 'mispar_rechev', enrichmentChain: ['private_cars_2', 'modelDetails', 'modelCounts', 'importers'] },
        private_cars_2: { id: '0866573c-40cd-4ca8-91d2-9dd2d7a492e5', doc_id: '#1', name: '×¨×›×‘ ×¤×¨×˜×™ ×•××¡×—×¨×™ 2', type: 'enrichment', searchField: 'mispar_rechev' },
        // #2 - Primary: Personal Import Cars
        personalImport: { id: '03adc637-b6fe-402b-9937-7c3d3afc9140', doc_id: '#2', name: '×¨×›×‘ ×‘×™×‘×•× ××™×©×™', type: 'primary', searchField: 'mispar_rechev', enrichmentChain: ['modelDetails', 'modelCounts', 'importers'] },
        // #3 - Status: Off-Road Vehicles (Grouped)
        offRoad_1: { id: '851ecab1-0622-4dbe-a6c7-f950cf82abf9', doc_id: '#3', name: '×™×¨×“ ××”×›×‘×™×© 1', type: 'status_group', searchField: 'mispar_rechev', msg: '×”×¨×›×‘ ×”×•×¨×“ ××”×›×‘×™×©', enrichmentChain: ['modelDetails'] },
        offRoad_2: { id: 'ec8cbc34-72e1-4b69-9c48-22821ba0bd6c', doc_id: '#3', name: '×™×¨×“ ××”×›×‘×™×© 2', type: 'status_group', searchField: 'mispar_rechev', msg: '×”×¨×›×‘ ×”×•×¨×“ ××”×›×‘×™×©', enrichmentChain: [] },
        offRoad_3: { id: '4e6b9724-4c1e-43f0-909a-154d4cc4e046', doc_id: '#3', name: '×™×¨×“ ××”×›×‘×™×© 3', type: 'status_group', searchField: 'mispar_rechev', msg: '×”×¨×›×‘ ×”×•×¨×“ ××”×›×‘×™×©', enrichmentChain: [] },
        // #4 - Status: Inactive (Frozen) with Model
        frozen_with_model: { id: 'f6efe89a-fb3d-43a4-bb61-9bf12a9b9099', doc_id: '#4', name: '××•×§×¤× (×¢× ×“×’×)', type: 'status', searchField: 'mispar_rechev', msg: '×¨×™×©×™×•×Ÿ ×”×¨×›×‘ ××™× ×• ×‘×ª×•×§×£ (××•×§×¤×)', enrichmentChain: ['modelDetails'] },
        // #5 - Status: Inactive (Frozen) without Model
        frozen_no_model: { id: '6f6acd03-f351-4a8f-8ecf-df792f4f573a', doc_id: '#5', name: '××•×§×¤× (×œ×œ× ×“×’×)', type: 'status', searchField: 'mispar_rechev', msg: '×¨×™×©×™×•×Ÿ ×”×¨×›×‘ ××™× ×• ×‘×ª×•×§×£ (××•×§×¤×)', enrichmentChain: ['modelDetails'] },
        // #6 - Primary: Heavy Vehicles
        heavy: { id: 'cd3acc5c-03c3-4c89-9c54-d40f93c0d790', doc_id: '#6', name: '×¨×›×‘ ×›×‘×“ ××• ×—×¡×¨ ×§×•×“ ×“×’×', type: 'primary', searchField: 'mispar_rechev', enrichmentChain: ['cme', 'publicTransport'] },
        // #7 - Primary: Engineering Equipment (CME)
        cme: { id: '58dc4654-16b1-42ed-8170-98fadec153ea', doc_id: '#7', name: '×›×œ×™ ×¦×"×”', type: 'primary', searchField: 'mispar_tzama', dataType: 'number', enrichmentChain: [] },
        // #8 - Primary: Two-Wheeled Vehicles
        twoWheeled: { id: 'bf9df4e2-d90d-4c0a-a400-19e15af8e95f', doc_id: '#8', name: '×“×•-×’×œ×’×œ×™', type: 'primary', searchField: 'mispar_rechev', enrichmentChain: [] },
        // #9 - Primary: Public Transport
        publicTransport: { id: 'cf29862d-ca25-4691-84f6-1be60dcb4a1e', doc_id: '#9', name: '×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª', type: 'primary', searchField: 'mispar_rechev', enrichmentChain: ['modelDetails', 'busFleet'] },
        // #10 - Enrichment: Vehicle History
        history_1: { id: '56063a99-8a3e-4ff4-912e-5966c0279bad', doc_id: '#10', name: '×”×™×¡×˜×•×¨×™×™×ª ×¨×›×‘ 1', type: 'enrichment', searchField: 'mispar_rechev' },
        history_2: { id: 'bb2355dc-9ec7-4f06-9c3f-3344672171da', doc_id: '#10', name: '×”×™×¡×˜×•×¨×™×™×ª ×‘×¢×œ×•×™×•×ª', type: 'enrichment', searchField: 'mispar_rechev', dataType: 'number', isArray: true },
        // #11 - Enrichment: Model Details & Counts
        modelDetails: { id: '142afde2-6228-49f9-8a29-9b6c3a0cbe40', doc_id: '#11', name: '×¤×¨×˜×™ ×“×’×', type: 'enrichment' },
        modelCounts: { id: '5e87a7a1-2f6f-41c1-8aec-7216d52a6cf6', doc_id: '#11', name: '×›××•×™×•×ª ×“×’×', type: 'enrichment' },
        // #12 - Enrichment: Recall
        recall: { id: '36bf1404-0be4-49d2-82dc-2f1ead4a8b93', doc_id: '#12', name: '×”×ª×¨××ª ×¨×™×§×•×œ', type: 'enrichment', searchField: 'MISPAR_RECHEV', isArray: true },
        // #13 - Enrichment: Importers
        importers: { id: '39f455bf-6db0-4926-859d-017f34eacbcb', doc_id: '#13', name: '×™×‘×•×× ×™×', type: 'enrichment' },
        // #14 - Enrichment: Disabled Permit
        disabledPermit: { id: 'c8b9f9c8-4612-4068-934f-d4acd2e3c06e', doc_id: '#14', name: '×ª×’ × ×›×”', type: 'enrichment', searchMethod: 'q', searchField: 'MISPAR RECHEV', isArray: true },
        // #15 - Enrichment: Pollution Filters
        filters: { id: '7cb2bd95-bf2e-49b6-aea1-fcb5ff6f0473', doc_id: '#15', name: '××¡× × ×™ ×–×™×”×•×', type: 'enrichment', searchField: 'mispar_rechev' },
        // #16 - Enrichment: Safety Discount
        safetyDiscount: { id: '83bfb278-7be1-4dab-ae2d-40125a923da1', doc_id: '#16', name: '×”× ×—×ª ×‘×˜×™×—×•×ª', type: 'enrichment', searchField: 'mispar_rechev', isArray: true },
        // #17 - Enrichment: Bus Fleet
        busFleet: { id: '91d298ed-a260-4f93-9d50-d5e3c5b82ce1', doc_id: '#17', name: '×¦×™×™ ××•×˜×•×‘×•×¡×™×', type: 'enrichment', searchField: 'bus_license_id' },
    };
    
    // ×¡×“×¨ ×”×¢×“×™×¤×•×ª ×©×œ ×”×—×™×¤×•×© ×”×¨××©×•× ×™.
    const DISCOVERY_PRIORITY = ['private_cars_1', 'personalImport', 'offRoad_group', 'heavy', 'cme', 'twoWheeled', 'publicTransport', 'frozen_with_model', 'frozen_no_model'];

    // ×¨×©×™××ª ×”×¢×©×¨×•×ª ×©×¨×œ×•×•× ×˜×™×ª ×œ×›×œ ×¨×›×‘ ×¢× ××¡×¤×¨ ×¨×™×©×•×™ ×¡×˜× ×“×¨×˜×™.
    const UNIVERSAL_ENRICHMENT_CHAIN = ['history_1', 'history_2', 'recall', 'disabledPermit', 'safetyDiscount', 'filters'];

    // ===================================================================================
    // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ (Formatting Helpers) ---
    // ===================================================================================
    const formatDate = (d) => { if (!d) return null; let s = String(d).split('T')[0].split(' ')[0]; return /^\d{8}$/.test(s) ? `${s.slice(6,8)}/${s.slice(4,6)}/${s.slice(0,4)}` : /^\d{6}$/.test(s) ? `${s.slice(4,6)}/${s.slice(0,4)}` : (new Date(s).getTime() ? new Date(s).toLocaleDateString('he-IL', {year:'numeric',month:'2-digit',day:'2-digit'}) : s); };
    const formatBool = (v) => v === true || String(v) === '1' ? '×›×Ÿ' : (v === false || String(v) === '0' ? '×œ×' : v);
    const formatPlate = (p) => { if (!p) return ''; let s = String(p); return s.length === 7 ? s.replace(/(\d{2})(\d{3})(\d{2})/, '$1-$2-$3') : s.length === 8 ? s.replace(/(\d{3})(\d{2})(\d{3})/, '$1-$2-$3') : s; };

    // ===================================================================================
    // --- ×œ×™×‘×ª ×”××¢×¨×›×ª: ×©×œ×™×¤×ª × ×ª×•× ×™× ×•×—×™×¤×•×© ---
    // ===================================================================================

    function fetchData(key, query) {
        return new Promise((resolve, reject) => {
            const source = DATA_SOURCES[key];
            if (!source) return reject({ error: `Source key "${key}" not found.` });

            let qValue = query;
            if (typeof query === 'string' && source.dataType === 'number') {
                qValue = parseInt(query, 10);
                if (isNaN(qValue)) return reject({ error: 'Invalid number for query' });
            }

            const cb = 'j' + Date.now() + Math.floor(Math.random() * 1e5);
            const params = new URLSearchParams({ resource_id: source.id, callback: cb });
            const q = typeof qValue === 'object' ? qValue : (source.searchMethod === 'q' ? qValue : { [source.searchField]: qValue });
            params.append(source.searchMethod === 'q' ? 'q' : 'filters', source.searchMethod === 'q' ? q : JSON.stringify(q));
            
            const url = `${API_BASE_URL}?${params.toString()}`;
            if (DEBUG_MODE) console.log(`%c[×©×œ×™×—×ª ×‘×§×©×”] ×‘×•×“×§ ×‘×××’×¨ ${source.doc_id} (${source.name}):`, 'color: blue; font-weight: bold;', url);

            const script = document.createElement('script');
            script.src = url;
            
            window[cb] = (data) => {
                document.body.removeChild(script);
                delete window[cb];
                if (data.success && data.result?.records?.length > 0) {
                    if (DEBUG_MODE) console.log(`%c[×ª×©×•×‘×” ×—×™×•×‘×™×ª] ××××’×¨ ${source.doc_id} (${source.name}):`, 'color: green;', data);
                    resolve({ sourceKey: key, records: data.result.records });
                } else {
                    if (DEBUG_MODE) console.log(`%c[×ª×©×•×‘×” ×©×œ×™×œ×™×ª] ××××’×¨ ${source.doc_id} (${source.name}): ×œ× × ××¦××• × ×ª×•× ×™×.`, 'color: orange;', data);
                    reject({ error: `No records found in ${source.name}`, response: data });
                }
            };
            
            script.onerror = (err) => {
                if(window[cb]) delete window[cb];
                try { document.body.removeChild(script); } catch(e){}
                if (DEBUG_MODE) console.error(`%c[×©×’×™××ª ×ª×§×©×•×¨×ª] ×‘×××’×¨ ${source.doc_id} (${source.name})`, 'color: red;', err);
                reject({ error: `Failed to fetch from ${source.name}` });
            };
            
            document.body.appendChild(script);
        });
    }

    const findInOffRoadGroup = async (plateToSearch) => {
        if (DEBUG_MODE) console.log(`%c[×—×™×¤×•×© ×××•×§×“] ×‘×•×“×§ ×‘×××’×¨×™ '×™×¨×“ ××”×›×‘×™×©' [#3] ×¢× ××¡×¤×¨: ${plateToSearch}`, 'color: purple; font-weight: bold;');
        try {
            const offRoadPromises = [fetchData('offRoad_1', plateToSearch), fetchData('offRoad_2', plateToSearch), fetchData('offRoad_3', plateToSearch)];
            return await Promise.any(offRoadPromises);
        } catch (e) {
            return null;
        }
    };
    
    async function searchVehicle() {
        const initialPlate = plateInput.value.trim().replace(/-/g, '');
        if (!/^\d{4,8}$/.test(initialPlate)) {
            resultsArea.innerHTML = `<p class="status-message error">×× × ×”×–×Ÿ ××¡×¤×¨ ×¨×™×©×•×™ ×ª×§× ×™.</p>`;
            return;
        }
        
        searchButton.disabled = true;
        searchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ××—×¤×©...';
        resultsArea.innerHTML = '<div class="loader"></div>';
        actionButtons.classList.add('hidden');
        licensePlateDisplay.classList.add('hidden');
        window.history.pushState({ plate: initialPlate }, '', `${window.location.pathname}?search=${initialPlate}`);

        const findVehicle = async (plateToSearch) => {
            currentPlate = plateToSearch;
            let winner = null;
            for (const key of DISCOVERY_PRIORITY) {
                try {
                    if (key === 'offRoad_group') {
                        winner = await findInOffRoadGroup(plateToSearch);
                    } else {
                        winner = await fetchData(key, plateToSearch);
                    }
                    if (winner) {
                        if (DEBUG_MODE) console.log(`%c[××¦×™××”!] × ××¦××” ×”×ª×××” ×‘×××’×¨ ×”×¨××©×™: ${DATA_SOURCES[winner.sourceKey].name} ×¢×‘×•×¨ ××¡×¤×¨ ${plateToSearch}`, 'background: #28a745; color: white; padding: 2px 5px; border-radius: 3px;');
                        return winner;
                    }
                } catch (e) { /* Continue */ }
            }
            return null;
        };
        
        let winner = await findVehicle(initialPlate);

        if (!winner && initialPlate.length < 8) {
            const paddedPlate = initialPlate.padStart(8, '0');
            winner = await findInOffRoadGroup(paddedPlate);
            if (winner) {
                currentPlate = paddedPlate;
            }
        }
        
        if (winner) {
            const source = DATA_SOURCES[winner.sourceKey];
            let statusMessage = '';
            if (source.type === 'status' || source.type === 'status_group') {
                const date = formatDate(winner.records[0].bitul_dt || winner.records[0].taarich_bitzul || winner.records[0].tokef_dt);
                statusMessage = `<div class="status-message error"><strong>${source.msg}</strong><br/><small>×ª××¨×™×š: ${date || '×œ× ×¦×•×™×Ÿ'}</small></div>`;
            } else if (winner.records[0].bitul_nm === '×”×¤×§×“×”') {
                statusMessage = `<div class="status-message"><strong>×¡×˜×˜×•×¡: ×¨×™×©×™×•×Ÿ ××•×¤×§×“</strong></div>`;
            }
            await enrichAndDisplay(winner.records[0], winner.sourceKey, statusMessage);
        } else {
            currentPlate = initialPlate;
            resultsArea.innerHTML = `<p class="status-message">×œ× × ××¦××• × ×ª×•× ×™× ×¢×‘×•×¨ <strong>${formatPlate(currentPlate)}</strong>.</p>`;
        }
        
        searchButton.disabled = false;
        searchButton.innerHTML = '<i class="fas fa-search"></i> ×—×™×¤×•×©';
    }

    async function enrichAndDisplay(baseData, sourceKey, statusMessage = '') {
        let finalData = { ...baseData };
        
        const runEnrichmentStage = async (currentData, keysToFetch) => {
            const plateForEnrichment = currentData.mispar_rechev || currentData.mispar_tzama || currentData.bus_license_id || currentPlate;
            const promises = keysToFetch.map(key => {
                const source = DATA_SOURCES[key];
                if (!source) return Promise.resolve(null);
                let query;
                if (key === 'modelDetails' || key === 'importers' || key === 'modelCounts') {
                    let modelQuery = {};
                    switch (key) {
                        case 'modelDetails': modelQuery = { tozeret_cd: currentData.tozeret_cd, kinuy_mishari: currentData.kinuy_mishari, shnat_yitzur: currentData.shnat_yitzur, ramat_gimur: currentData.ramat_gimur, delek_nm: currentData.sug_delek_nm, degem_nm: currentData.degem_nm }; break;
                        case 'modelCounts': case 'importers': modelQuery = { tozeret_nm: currentData.tozeret_nm, kinuy_mishari: currentData.kinuy_mishari, shnat_yitzur: currentData.shnat_yitzur, degem_nm: currentData.degem_nm, degem_cd: currentData.degem_cd }; break;
                    }
                    Object.keys(modelQuery).forEach(k => (modelQuery[k] == null || String(modelQuery[k]).trim() === '') && delete modelQuery[k]);
                    if (Object.keys(modelQuery).length === 0) return Promise.resolve(null);
                    query = modelQuery;
                } else {
                    query = plateForEnrichment;
                }
                return fetchData(key, query).catch(e => null);
            });
            return (await Promise.all(promises)).filter(Boolean);
        };

        const specificChain = DATA_SOURCES[sourceKey]?.enrichmentChain || [];
        const fullChain = [...new Set([...specificChain, ...UNIVERSAL_ENRICHMENT_CHAIN])];
        
        if (DEBUG_MODE) console.log(`%c[×”×¢×©×¨×ª ××™×“×¢ - ×©×œ×‘ 1] ××ª×—×™×œ ×©×¨×©×¨×ª ×××•×—×“×ª: ${fullChain.join(', ')}`, 'color: #fd7e14; font-weight: bold;');
        const stage1Results = await runEnrichmentStage(finalData, fullChain);

        let newChainsToRun = new Set();
        for (const res of stage1Results) {
            if (DATA_SOURCES[res.sourceKey]?.isArray) {
                finalData[res.sourceKey] = res.records;
            } else {
                finalData = { ...finalData, ...res.records[0] };
            }
            const fulfilledSourceDef = DATA_SOURCES[res.sourceKey];
            if ((fulfilledSourceDef?.type === 'primary' || fulfilledSourceDef?.type === 'enrichment') && fulfilledSourceDef.enrichmentChain) {
                fulfilledSourceDef.enrichmentChain.forEach(key => newChainsToRun.add(key));
            }
        }

        const finalChain = Array.from(newChainsToRun).filter(key => !fullChain.includes(key));
        if (finalChain.length > 0) {
            if (DEBUG_MODE) console.log(`%c[×”×¢×©×¨×ª ××™×“×¢ - ×©×œ×‘ 2] × ×•×¡×¤×• ×©×¨×©×¨××•×ª ×”×¢×©×¨×”: ${finalChain.join(', ')}`, 'color: #9d33ff; font-weight: bold;');
            const stage2Results = await runEnrichmentStage(finalData, finalChain);
            for (const res of stage2Results) {
                if (DATA_SOURCES[res.sourceKey]?.isArray) {
                    finalData[res.sourceKey] = res.records;
                } else {
                    finalData = { ...finalData, ...res.records[0] };
                }
            }
        }
        
        displayResults(finalData, sourceKey, statusMessage);
    }
    
    // ===================================================================================
    // --- ××¢×¨×š ×”×’×“×¨×•×ª ×ª×¦×•×’×” (FIELD_LABELS) ---
    // ===================================================================================
    const FIELD_LABELS = {
      // General & Identification (×›×œ×œ×™ ×•×–×™×”×•×™)
      'tozeret_nm': { l: '×™×¦×¨×Ÿ', i: 'fas fa-industry', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'kinuy_mishari': { l: '×›×™× ×•×™ ××¡×—×¨×™', i: 'fas fa-tag', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'degem_nm': { l: '×“×’×', i: 'fas fa-barcode', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'sug_rechev_nm': { l: '×¡×•×’ ×¨×›×‘', i: 'fas fa-car', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'shnat_yitzur': { l: '×©× ×ª ×™×™×¦×•×¨', i: 'fas fa-calendar-days', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'tzeva_rechev': { l: '×¦×‘×¢', i: 'fas fa-palette', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'sug_yevu': { l: '×¡×•×’ ×™×‘×•×', i: 'fas fa-globe-americas', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'shem_yevuan': { l: '×©× ×™×‘×•××Ÿ', i: 'fas fa-building', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'tozeret_eretz_nm': { l: '××¨×¥ ×™×™×¦×•×¨', i: 'fas fa-flag', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'production_country': { l: '××¨×¥ ×™×™×¦×•×¨', i: 'fas fa-flag', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'mispar_rechavim_pailim': { l: '×¡×”"×› ×¢×œ ×”×›×‘×™×©', i: 'fas fa-list-ol', c: '×›×œ×œ×™ ×•×–×™×”×•×™', t: 'count' },
      'horaat_rishum': { l: '×”×•×¨××ª ×¨×™×©×•×', i: 'fas fa-file-invoice', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'misgeret': { l: '××¡×¤×¨ ×©×œ×“×”', i: 'fas fa-fingerprint', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'mispar_shilda': { l: '××¡×¤×¨ ×©×œ×“×”', i: 'fas fa-fingerprint', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'shilda': { l: '××¡×¤×¨ ×©×œ×“×”', i: 'fas fa-fingerprint', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'sug_tkina_nm': { l: '×¡×•×’ ×ª×§×™× ×”', i: 'fas fa-stamp', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'tkina_EU': { l: '×ª×§×™× ×ª EU', i: 'fas fa-certificate', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'sug_rechev_EU_cd': { l: '×ª×§×™× ×ª EU', i: 'fas fa-certificate', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'mkoriut_nm': { l: '××§×•×¨×™×•×ª', i: 'fas fa-file-signature', c: '×›×œ×œ×™ ×•×–×™×”×•×™' },
      'mehir': { l: '××—×™×¨ ×™×‘×•××Ÿ', i: 'fas fa-shekel-sign', c: '×›×œ×œ×™ ×•×–×™×”×•×™', f: 'currency' },

      // Engine & Powertrain (×× ×•×¢ ×•×”× ×¢×”)
      'tozar_manoa': { l: '×™×¦×¨×Ÿ ×× ×•×¢', i: 'fas fa-industry', c: '×× ×•×¢ ×•×”× ×¢×”' },
      'degem_manoa': { l: '×“×’× ×× ×•×¢', i: 'fas fa-gear', c: '×× ×•×¢ ×•×”× ×¢×”' },
      'mispar_manoa': { l: '××¡×¤×¨ ×× ×•×¢', i: 'fas fa-hashtag', c: '×× ×•×¢ ×•×”× ×¢×”' },
      'nefach_manoa': { l: '× ×¤×— ×× ×•×¢ (×¡×"×§)', i: 'fas fa-gears', c: '×× ×•×¢ ×•×”× ×¢×”', f: 'number' },
      'koah_sus': { l: '×”×¡×¤×§ (×›"×¡)', i: 'fas fa-horse-head', c: '×× ×•×¢ ×•×”× ×¢×”' },
      'hespek': { l: '×”×¡×¤×§ (×›"×¡)', i: 'fas fa-horse-head', c: '×× ×•×¢ ×•×”× ×¢×”' },
      'sug_delek_nm': { l: '×¡×•×’ ×“×œ×§', i: 'fas fa-gas-pump', c: '×× ×•×¢ ×•×”× ×¢×”' },
      'PropulsionType_nm': { l: '×¡×•×’ ×”× ×¢×”', i: 'fas fa-charging-station', c: '×× ×•×¢ ×•×”× ×¢×”' },
      'hanaa_nm': { l: '×”× ×¢×”', i: 'fas fa-circle-nodes', c: '×× ×•×¢ ×•×”× ×¢×”' },
      'automatic_ind': { l: '×’×™×¨ ××•×˜×•××˜×™', i: 'fas fa-gears', c: '×× ×•×¢ ×•×”× ×¢×”', f: 'bool' },
      'gapam_ind': { l: '×”×¡×‘×” ×œ×’×¤"×', i: 'fas fa-gas-pump', c: '×× ×•×¢ ×•×”× ×¢×”', f: 'bool' },
      'dg_metach_solela': { l: '××ª×— ×¡×•×œ×œ×” (V)', i: 'fas fa-car-battery', c: '×× ×•×¢ ×•×”× ×¢×”' },
      
      // License & Ownership (×¨×™×©×•×™ ×•×‘×¢×œ×•×ª)
      'mispar_yad_nochichi': { l: '×™×“', i: 'fas fa-hand-holding', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª' },
      'moed_aliya_lakvish': { l: '×¢×œ×™×” ×œ×›×‘×™×©', i: 'fas fa-road', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª', f: 'date' },
      'tokef_dt': { l: '×ª×•×§×£ ×¨×™×©×™×•×Ÿ', i: 'fas fa-check-circle', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª', f: 'date' },
      'mivchan_acharon_dt': { l: '×˜×¡×˜ ××—×¨×•×Ÿ', i: 'fas fa-history', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª', f: 'date' },
      'rishum_rishon_dt': { l: '×¨×™×©×•× ×¨××©×•× ×™', i: 'fas fa-file-lines', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª', f: 'date' },
      'rishum_date': { l: '×ª××¨×™×š ×¨×™×©×•×', i: 'fas fa-file-lines', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª', f: 'date' },
      'baalut': { l: '×‘×¢×œ×•×ª × ×•×›×—×™×ª', i: 'fas fa-user-tag', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª' },
      'kilometer_test_aharon': { l: '×§"× ×‘×˜×¡×˜ ××—×¨×•×Ÿ', i: 'fas fa-gauge-high', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª', f: 'number' },
      'total_kilometer': { l: '×§×™×œ×•××˜×¨××–\' ×›×•×œ×œ', i: 'fas fa-road-circle-check', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª', f: 'number'},
      'kvuzat_agra_cd': { l: '×§×‘×•×¦×ª ××’×¨×”', i: 'fas fa-dollar-sign', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª' },
      'bitul_nm': { l: '×¡×˜×˜×•×¡ ×‘×™×˜×•×œ', i: 'fas fa-ban', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª' },
      'tokef_date': { l: '×ª×•×§×£ ×¨×™×©×•×™ (×¦×"×”)', i: 'fas fa-check-circle', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª', f: 'date' },
      'shinui_mivne_ind': { l: '×¢×‘×¨ ×©×™× ×•×™ ××‘× ×”', i: 'fas fa-screwdriver-wrench', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª', f: 'bool' },
      'shnui_zeva_ind': { l: '×¢×‘×¨ ×©×™× ×•×™ ×¦×‘×¢', i: 'fas fa-spray-can', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª', f: 'bool' },
      'shinui_zmig_ind': { l: '×¢×‘×¨ ×©×™× ×•×™ ×¦××™×’×™×', i: 'fas fa-ruler-combined', c: '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª', f: 'bool' },
      
      // Dimensions & Weights (××™×“×•×ª ×•××©×§×œ×™×)
      'mishkal_kolel': { l: '××©×§×œ ×›×•×œ×œ (×§"×’)', i: 'fas fa-weight-hanging', c: '××™×“×•×ª ×•××©×§×œ×™×', f: 'number' },
      'mishkal_azmi': { l: '××©×§×œ ×¢×¦××™ (×§"×’)', i: 'fas fa-weight-scale', c: '××™×“×•×ª ×•××©×§×œ×™×', f: 'number' },
      'merkav': { l: '××¨×›×‘', i: 'fas fa-car-side', c: '××™×“×•×ª ×•××©×§×œ×™×' },
      'mispar_dlatot': { l: '××¡×¤×¨ ×“×œ×ª×•×ª', i: 'fas fa-door-open', c: '××™×“×•×ª ×•××©×§×œ×™×' },
      'gova': {l: '×’×•×‘×” (×"×)', i:'fas fa-ruler-vertical', c: '××™×“×•×ª ×•××©×§×œ×™×', f:'number'},
      'mispar_moshavim': { l: '××¡×¤×¨ ××•×©×‘×™×', i: 'fas fa-chair', c: '××™×“×•×ª ×•××©×§×œ×™×' },
      'SeatsNum': { l: '××¡×¤×¨ ××•×©×‘×™×', i: 'fas fa-chair', c: '××™×“×•×ª ×•××©×§×œ×™×' },
      'argaz_ind': { l: '××¨×’×–', i: 'fas fa-box', c: '××™×“×•×ª ×•××©×§×œ×™×', f: 'bool' },

      // Tires & Rims (×¦××™×’×™× ×•×—×™×©×•×§×™×)
      'galgaley_sagsoget_kala_ind': {l: "×—×™×©×•×§×™ ×¡×’×¡×•×’×ª ×§×œ×” (×’'×× ×˜ ××’× ×–×™×•×)", i: 'fas fa-fan', c: '×¦××™×’×™× ×•×—×™×©×•×§×™×', f: 'bool'},
      'zmig_kidmi': { l: '××™×“×•×ª ×¦××™×’ ×§×“××™', i: 'fas fa-circle-dot', c: '×¦××™×’×™× ×•×—×™×©×•×§×™×' },
      'zmig_ahori': { l: '××™×“×•×ª ×¦××™×’ ××—×•×¨×™', i: 'fas fa-circle-dot', c: '×¦××™×’×™× ×•×—×™×©×•×§×™×' },
      'kod_omes_tzmig_kidmi': { l: '×§×•×“ ×¢×•××¡ (×§×“××™)', i: 'fas fa-weight-scale', c: '×¦××™×’×™× ×•×—×™×©×•×§×™×' },
      'kod_omes_tzmig_ahori': { l: '×§×•×“ ×¢×•××¡ (××—×•×¨×™)', i: 'fas fa-weight-scale', c: '×¦××™×’×™× ×•×—×™×©×•×§×™×' },
      'kod_mehirut_tzmig_kidmi': { l: '×§×•×“ ××”×™×¨×•×ª (×§×“××™)', i: 'fas fa-gauge-high', c: '×¦××™×’×™× ×•×—×™×©×•×§×™×' },
      'kod_mehirut_tzmig_ahori': { l: '×§×•×“ ××”×™×¨×•×ª (××—×•×¨×™)', i: 'fas fa-gauge-high', c: '×¦××™×’×™× ×•×—×™×©×•×§×™×' },
      
      // Equipment & Comfort (××‘×–×•×¨ ×•× ×•×—×•×ª)
      'ramat_gimur': { l: '×¨××ª ×’×™××•×¨', i: 'fas fa-star', c: '××‘×–×•×¨ ×•× ×•×—×•×ª' },
      'mazgan_ind': { l: '××–×’×Ÿ', i: 'fas fa-snowflake', c: '××‘×–×•×¨ ×•× ×•×—×•×ª', f: 'bool' },
      'hege_koah_ind': { l: '×”×’×” ×›×•×—', i: 'fas fa-bullseye', c: '××‘×–×•×¨ ×•× ×•×—×•×ª', f: 'bool' },
      'mispar_halonot_hashmal': { l: '×—×œ×•× ×•×ª ×—×©××œ', i: 'fas fa-window-maximize', c: '××‘×–×•×¨ ×•× ×•×—×•×ª' },
      'halon_bagg_ind': {l: '×—×œ×•×Ÿ ×‘×’×’', i: 'fas fa-cloud-sun', c: '××‘×–×•×¨ ×•× ×•×—×•×ª', f: 'bool'},
      'matzlemat_reverse_ind': { l: '××¦×œ××ª ×¨×•×•×¨×¡', i: 'fas fa-camera-retro', c: '××‘×–×•×¨ ×•× ×•×—×•×ª', f: 'bool' },
      'grira_nm': { l: '×•×• ×’×¨×™×¨×”', i: 'fas fa-trailer', c: '××‘×–×•×¨ ×•× ×•×—×•×ª' },
      
      // CME & Heavy Vehicles (× ×ª×•× ×™ ×¦×"×” ×•×¨×›×‘ ×›×‘×“)
      'sug_tzama_nm': { l: '×¡×•×’ ×¦×"×”', i: 'fas fa-tractor', c: '× ×ª×•× ×™ ×¦×"×” ×•×¨×›×‘ ×›×‘×“' },
      'shilda_totzar_en_nm': { l: '×™×¦×¨×Ÿ ×©×œ×“×” (×¦×"×”)', i: 'fas fa-industry', c: '× ×ª×•× ×™ ×¦×"×” ×•×¨×›×‘ ×›×‘×“' },
      'mishkal_ton': { l: '××©×§×œ (×˜×•×Ÿ)', i: 'fas fa-weight-hanging', c: '× ×ª×•× ×™ ×¦×"×” ×•×¨×›×‘ ×›×‘×“' },
      'kosher_harama_ton': { l: '×›×•×©×¨ ×”×¨××” (×˜×•×Ÿ)', i: 'fas fa-scale-unbalanced-flip', c: '× ×ª×•× ×™ ×¦×"×” ×•×¨×›×‘ ×›×‘×“' },
      'hagbala_nm_1': {l:'×”×’×‘×œ×” 1', i:'fas fa-triangle-exclamation', c:'× ×ª×•× ×™ ×¦×"×” ×•×¨×›×‘ ×›×‘×“'},
      'hagbala_nm_2': {l:'×”×’×‘×œ×” 2', i:'fas fa-triangle-exclamation', c:'× ×ª×•× ×™ ×¦×"×” ×•×¨×›×‘ ×›×‘×“'},

      // Public Transport & Fleet (×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª ×•×¦×™ ×¨×›×‘)
      'operator_nm': { l: '××¤×¢×™×œ', i: 'fas fa-bus-simple', c: '×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª ×•×¦×™ ×¨×›×‘' },
      'cluster_nm': { l: '××©×›×•×œ ×©×™×¨×•×ª', i: 'fas fa-sitemap', c: '×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª ×•×¦×™ ×¨×›×‘' },
      'BusSize_nm': {l:'×’×•×“×œ ××•×˜×•×‘×•×¡', i:'fas fa-bus', c:'×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª ×•×¦×™ ×¨×›×‘'},
      'BusType_nm': {l:'×¡×•×’ ××•×˜×•×‘×•×¡', i:'fas fa-bus-simple', c:'×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª ×•×¦×™ ×¨×›×‘'},
      'mispar_mekomot_leyd_nahag': { l: '××•×©×‘×™× ×œ×™×“ ×”× ×”×’', i: 'fas fa-user-group', c: '×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª ×•×¦×™ ×¨×›×‘' },
      
      // Passive Safety (×‘×˜×™×—×•×ª ×¤×¡×™×‘×™×ª)
      'ramat_eivzur_betihuty': { l: '×¨××ª ×‘×˜×™×—×•×ª', i: 'fas fa-shield-halved', c: '×‘×˜×™×—×•×ª ×¤×¡×™×‘×™×ª' , t: 'bar', max: 8 },
      'mispar_kariot_avir': { l: '×›×¨×™×•×ª ××•×•×™×¨', i: 'fas fa-air-freshener', c: '×‘×˜×™×—×•×ª ×¤×¡×™×‘×™×ª' },
      'abs_ind': { l: 'ABS', i: 'fas fa-braille', c: '×‘×˜×™×—×•×ª ×¤×¡×™×‘×™×ª', f: 'bool' },
      'bakarat_yatzivut_ind': { l: '×‘×§×¨×ª ×™×¦×™×‘×•×ª', i: 'fas fa-road-circle-check', c: '×‘×˜×™×—×•×ª ×¤×¡×™×‘×™×ª', f: 'bool' },
      'hayshaney_hagorot_ind': { l: '×—×™×™×©× ×™ ×—×’×•×¨×•×ª', i: 'fas fa-user-shield', c: '×‘×˜×™×—×•×ª ×¤×¡×™×‘×™×ª', f: 'bool' },
      'hayshaney_lahatz_avir_batzmigim_ind': { l: '×—×™×™×©× ×™ ×œ×—×¥ ××•×•×™×¨', i: 'fas fa-circle-exclamation', c: '×‘×˜×™×—×•×ª ×¤×¡×™×‘×™×ª', f: 'bool' },

      // Active Safety Systems (××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª)
      'bakarat_stiya_menativ_ind': { l: '×”×ª×¨××ª ×¡×˜×™×” ×× ×ª×™×‘', i: 'fas fa-road-circle-exclamation', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f: 'bool' },
      'bakarat_stiya_activ_s': { l: '×‘×§×¨×ª ×¡×˜×™×” ××§×˜×™×‘×™×ª', i: 'fas fa-road-lock', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f: 'bool' },
      'nitur_merhak_milfanim_ind': { l: '× ×™×˜×•×¨ ××¨×—×§ ××œ×¤× ×™×', i: 'fas fa-car-on', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f: 'bool' },
      'zihuy_matzav_hitkarvut_mesukenet_ind': { l: '×”×ª×¨××ª ×”×ª× ×’×©×•×ª', i: 'fas fa-car-burst', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f: 'bool' },
      'bakarat_shyut_adaptivit_ind': { l: '×‘×§×¨×ª ×©×™×•×˜ ××“×¤×˜×™×‘×™×ª', i: 'fas fa-arrows-left-right-to-line', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f: 'bool' },
      'zihuy_holchey_regel_ind': {l: '×–×™×”×•×™ ×”×•×œ×›×™ ×¨×’×œ', i: 'fas fa-person-walking', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f:'bool'},
      'blimat_hirum_lifnei_holhei_regel_ofanaim': { l: '×‘×œ×™××ª ×—×™×¨×•× (×”×•×œ×›×™ ×¨×’×œ ×•×“×•-×’×œ×’×œ×™)', i: 'fas fa-person-biking', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f: 'bool' },
      'zihuy_rechev_do_galgali': {l: '×–×™×”×•×™ ×¨×›×‘ ×“×•-×’×œ×’×œ×™', i:'fas fa-motorcycle', c:'××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f:'bool'},
      'blima_otomatit_nesia_leahor': {l: '×‘×œ×™××” ××•×˜×•× ×•××™×ª ×‘×¨×•×•×¨×¡', i: 'fas fa-car-rear', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f:'bool'},
      'zihuy_beshetah_nistar_ind': {l: '× ×™×˜×•×¨ ×©×˜×— ××ª', i: 'fas fa-eye-slash', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f:'bool'},
      'hitnagshut_cad_shetah_met': { l: '×× ×™×¢×ª ×”×ª× ×’×©×•×ª ×‘×©×˜×— ××ª', i: 'fas fa-car-burst', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f: 'bool' },
      'zihuy_tamrurey_tnua_ind': {l: '×–×™×”×•×™ ×ª××¨×•×¨×™×', i: 'fas fa-traffic-light', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f:'bool'},
      'shlita_automatit_beorot_gvohim_ind': {l: '×©×œ×™×˜×” ××•×˜×•××˜×™×ª ×‘××•×¨×•×ª ×’×‘×•×”×™×', i: 'fas fa-lightbulb', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f:'bool'},
      'maarechet_ezer_labalam_ind': { l: '××¢×¨×›×ª ×¢×–×¨ ×œ×‘×œ×™××”', i: 'fas fa-parachute-box', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f: 'bool' },
      'bakarat_mehirut_isa': { l: '×‘×§×¨×ª ××”×™×¨×•×ª ×—×›××” (ISA)', i: 'fas fa-gauge-simple-high', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f: 'bool' },
      'alco_lock': { l: '× ×¢×™×œ×ª ××œ×›×•×”×•×œ', i: 'fas fa-user-lock', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', f: 'bool' },
      'stone_proof_nm': { l: '××™×’×•×Ÿ ××‘× ×™×', i: 'fas fa-shield-halved', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª' },
      'bullet_proof_nm': { l: '××™×’×•×Ÿ ×™×¨×™', i: 'fas fa-crosshairs', c: '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª' },
      
      // Emissions & Environment (×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”)
      'kvutzat_zihum': { l: '×§×‘×•×¦×ª ×–×™×”×•×', i: 'fas fa-smog', c: '×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”', t: 'bar', max: 15 },
      'technologiat_hanaa_nm': { l: '×˜×›× ×•×œ×•×’×™×™×ª ×”× ×¢×”', i: 'fas fa-charging-station', c: '×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”' },
      'madad_yarok': { l: '××“×“ ×™×¨×•×§', i: 'fas fa-leaf', c: '×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”' },
      'kamut_CO2_WLTP': { l: '×¤×œ×™×˜×ª CO2 (WLTP)', i: 'fas fa-cloud', c: '×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”' },
      'kamut_CO2': { l: '×¤×œ×™×˜×ª CO2 (NEDC)', i: 'fas fa-cloud', c: '×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”' },
      'kamut_NOX': { l: '×¤×œ×™×˜×ª NOX', i: 'fas fa-cloud', c: '×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”' },
      'kamut_PM10': { l: '×¤×œ×™×˜×ª PM10', i: 'fas fa-cloud', c: '×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”' },
      'kamut_CO2_city': { l: '×¤×œ×™×˜×ª CO2 (×¢×™×¨×•× ×™)', i: 'fas fa-city', c: '×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”' },
      'kamut_CO2_hway': { l: '×¤×œ×™×˜×ª CO2 (×‘×™× ×¢×™×¨×•× ×™)', i: 'fas fa-road', c: '×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”' },
      'sug_mamir_nm': { l: '×¡×•×’ ×××™×¨', i: 'fas fa-recycle', c: '×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”' },
      'taarich_hatkana': {l: '×ª××¨×™×š ×”×ª×§× ×ª ××¡× ×Ÿ', i:'fas fa-calendar-check', c:'×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”', f:'date' },
    };

    /**
     * ×¤×•× ×§×¦×™×” ×”××¦×™×’×” ××ª ×”×ª×•×¦××•×ª ×”×¡×•×¤×™×•×ª ×¢×œ ×”××¡×š.
     * ×›×•×œ×œ×ª ×œ×•×’×™×§×” ×œ× ×™×§×•×™ ×›×¤×™×œ×•×™×•×ª ×•×œ×”×¦×’×ª ×§×˜×’×•×¨×™×•×ª ×¨×œ×•×•× ×˜×™×•×ª ×‘×œ×‘×“.
     */
    function displayResults(vehicle, sourceKey, statusMessage = '') {
        const plate = vehicle.mispar_rechev || vehicle.mispar_tzama || vehicle.bus_license_id;
        
        if (vehicle.recall?.length > 0) {
            statusMessage += `<div class="status-message error"><strong>× ××¦××• ${vehicle.recall.length} ×§×¨×™××•×ª ×©×™×¨×•×ª (×¨×™×§×•×œ) ×¤×ª×•×—×•×ª!</strong></div>`;
        }
        if (vehicle.disabledPermit?.length > 0) {
            statusMessage += `<div class="status-message success"><strong>× ××¦× ×ª×• × ×›×” ×¤×¢×™×œ.</strong><br><small>×”×•×¤×§ ×‘×ª××¨×™×š: ${formatDate(vehicle.disabledPermit[0]['TAARICH HAFAKAT TAG'])} | ×¡×•×’: ${vehicle.disabledPermit[0]['SUG TAV'] === 2 ? '×›×™×¡× ×’×œ×’×œ×™×' : '×¨×’×™×œ'}</small></div>`;
        }
        if (vehicle.safetyDiscount?.length > 0) {
            statusMessage += `<div class="status-message success"><strong>×”×¨×›×‘ ×™×”×™×” ×–×›××™ ×œ×”× ×—×” ×‘××’×¨×ª ×¨×™×©×•×™ ×‘××™×“×” ×•×ª×•×ª×§×Ÿ ×‘×• ××¢×¨×›×ª ×‘×˜×™×—×•×ª (×›×“×•×’××ª ××•×‘×™×œ××™×™).</strong></div>`;
        }

        licensePlateDisplay.innerHTML = `<div class="license-plate"><div class="plate-country"><span class="flag">ğŸ‡®ğŸ‡±</span><span class="il">IL</span><span class="israel">×™×©×¨××œ</span></div><div class="plate-number">${formatPlate(plate)}</div></div>`;
        licensePlateDisplay.classList.remove('hidden');

        // --- × ×™×§×•×™ × ×ª×•× ×™× ×•×”×ª×××” ×œ×¤×™ ×¡×•×’ ×”×¨×›×‘ ---
        if (vehicle.production_country) vehicle.tozeret_eretz_nm = null;
        if (vehicle.SeatsNum != null) vehicle.mispar_moshavim = null;
        if (vehicle.PropulsionType_nm) vehicle.sug_delek_nm = null;
        if (vehicle.sug_rechev_EU_cd) vehicle.tkina_EU = null;
        if (sourceKey === 'twoWheeled') {
            vehicle.mispar_mekomot_leyd_nahag = null;
        }
        if (sourceKey === 'publicTransport' || sourceKey === 'heavy' || sourceKey === 'cme') {
            vehicle.grira_nm = null;
        }

        const categorized = {};
        for(const [key, spec] of Object.entries(FIELD_LABELS)) {
            const val = vehicle[key];
            if (val === null || val === undefined || val === '' || String(val).trim() === '') continue;
            
            if (!categorized[spec.c]) categorized[spec.c] = '';
            
            if (spec.t === 'count') {
                const active = Number(vehicle.mispar_rechavim_pailim) || 0;
                const inactive = Number(vehicle.mispar_rechavim_le_pailim) || 0;
                const total = active + inactive;
                
                let displayVal = active.toLocaleString();
                if (total > active) {
                    displayVal = `${active.toLocaleString()} ×¤×¢×™×œ×™× (××ª×•×š ${total.toLocaleString()} ×¡×”"×›)`;
                }
                categorized[spec.c] += `<li><strong><i class="${spec.i}"></i>${spec.l}</strong><span>${displayVal}</span></li>`;
            } else if (spec.t === 'bar') {
                const numVal = Number(val);
                if (isNaN(numVal) || numVal === 0) continue;
                categorized[spec.c] += `<li><strong><i class="${spec.i}"></i>${spec.l}</strong><span>${val} ××ª×•×š ${spec.max}<div class="rating-bar-container"><div class="rating-bar" style="width:${(numVal/spec.max)*100}%;"></div></div></span></li>`;
            } else {
                let fVal = val;
                if (spec.f === 'date') fVal = formatDate(val);
                else if (spec.f === 'bool') fVal = formatBool(val);
                else if (spec.f === 'number') fVal = Number(val).toLocaleString();
                else if (spec.f === 'currency') fVal = `â‚ª${Number(val).toLocaleString()}`;
                
                categorized[spec.c] += `<li><strong><i class="${spec.i}"></i>${spec.l}</strong><span>${fVal}</span></li>`;
            }
        }
        
        // ×‘× ×™×™×ª ×¡×“×¨ ×”×§×˜×’×•×¨×™×•×ª ×‘××•×¤×Ÿ ×“×™× ××™
        const categoryOrder = ['×›×œ×œ×™ ×•×–×™×”×•×™', '×× ×•×¢ ×•×”× ×¢×”', '×¨×™×©×•×™ ×•×‘×¢×œ×•×ª', '××™×“×•×ª ×•××©×§×œ×™×', '××‘×–×•×¨ ×•× ×•×—×•×ª', '×¦××™×’×™× ×•×—×™×©×•×§×™×', '×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª ×•×¦×™ ×¨×›×‘', '× ×ª×•× ×™ ×¦×"×” ×•×¨×›×‘ ×›×‘×“', '×‘×˜×™×—×•×ª ×¤×¡×™×‘×™×ª', '××¢×¨×›×•×ª ×‘×˜×™×—×•×ª ××§×˜×™×‘×™×•×ª', '×¤×œ×™×˜×•×ª ×•×¡×‘×™×‘×”'];
        if (sourceKey === 'twoWheeled') {
            const categoriesToRemove = ['×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª ×•×¦×™ ×¨×›×‘', '× ×ª×•× ×™ ×¦×"×” ×•×¨×›×‘ ×›×‘×“'];
            categoriesToRemove.forEach(cat => {
                const index = categoryOrder.indexOf(cat);
                if (index > -1) categoryOrder.splice(index, 1);
            });
        }

        let html = '';
        categoryOrder.forEach(cat => {
            if (categorized[cat]) {
                html += `<div><h4 class="section-title">${cat}</h4><ul>${categorized[cat]}</ul></div>`;
            }
        });

        if (vehicle.history_2?.length > 0) {
            html += `<div><h4 class="section-title">×”×™×¡×˜×•×¨×™×™×ª ×‘×¢×œ×•×™×•×ª</h4><div class="history-table-container"><table class="history-table"><thead><tr><th>×ª××¨×™×š ×‘×¢×œ×•×ª</th><th>×¡×•×’ ×‘×¢×œ×•×ª</th></tr></thead><tbody>`;
            vehicle.history_2.sort((a,b) => b.baalut_dt - a.baalut_dt).forEach(r => { html += `<tr><td>${formatDate(r.baalut_dt)}</td><td>${r.baalut}</td></tr>`; });
            html += `</tbody></table></div></div>`;
        }

        if (vehicle.recall?.length > 0) {
            html += `<div><h4 class="section-title">×§×¨×™××•×ª ×©×™×¨×•×ª (×¨×™×§×•×œ) ×¤×ª×•×—×•×ª</h4><div class="history-table-container"><table class="history-table"><thead><tr><th>×ª××¨×™×š ×¤×ª×™×—×”</th><th>×¡×•×’ ×ª×§×œ×”</th><th>×ª×™××•×¨</th></tr></thead><tbody>`;
            vehicle.recall.sort((a,b) => new Date(b.TAARICH_PTICHA) - new Date(a.TAARICH_PTICHA)).forEach(r => { 
                html += `<tr><td>${formatDate(r.TAARICH_PTICHA)}</td><td>${r.SUG_TAKALA}</td><td style="white-space: normal; text-align: right;">${r.TEUR_TAKALA}</td></tr>`; 
            });
            html += `</tbody></table></div></div>`;
        }

        resultsArea.innerHTML = statusMessage + html;
        if(html) actionButtons.classList.remove('hidden');
    }

    // --- Event Listeners ---
    plateInput.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); searchVehicle(); } });
    document.getElementById('printBtn').addEventListener('click', () => window.print());
    document.getElementById('downloadBtn').addEventListener('click', () => { html2canvas(document.querySelector(".results-wrapper"),{scrollY:-window.scrollY}).then(c=>{let l=document.createElement('a');l.download=`car-${currentPlate}.png`;l.href=c.toDataURL();l.click();});});
    document.getElementById('shareBtn').addEventListener('click', async () => { 
        const isEmbedded = (window.self !== window.top);
        const url = `${CANONICAL_URL}?search=${currentPlate}`; 

        if(navigator.share && !isEmbedded){
            try { await navigator.share({title:`×¤×¨×˜×™ ×¨×›×‘: ${formatPlate(currentPlate)}`,url}) } catch(e){}
        } else {
            try {
                await navigator.clipboard.writeText(url);
                const b=document.getElementById('shareBtn');
                b.innerHTML='<i class="fas fa-check"></i> ×”×•×¢×ª×§!';
                setTimeout(()=>{b.innerHTML='<i class="fas fa-share-alt"></i> ×©×™×ª×•×£';},2000)
            } catch {
                prompt("×”×¢×ª×§×ª ×§×™×©×•×¨:",url)
            }
        }
    });
    document.addEventListener('DOMContentLoaded', () => { document.getElementById('footer-year').textContent = `Â© ${new Date().getFullYear()} MyOto. ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª.`; const p = new URLSearchParams(window.location.search).get('search'); if(p){plateInput.value = formatPlate(p); searchVehicle();} });
  </script>

</body>
</html>
